name: VoltAir Supreme Continuous Execution ‚ö°üîí

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  supreme-continuous:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '20'
      PUBLISH_DIR: './_site'
      
    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Detect new zip or config changes
      - name: Detect VoltAir updates
        id: detect_changes
        run: |
          echo "Checking for new voltair-supreme-repo.zip or _config.yml changes..."
          git fetch origin main
          NEW_CHANGES=$(git diff --name-only HEAD origin/main | grep -E 'voltair-supreme-repo.zip|_config.yml')
          echo "changes=$NEW_CHANGES" >> $GITHUB_ENV
          if [ -z "$NEW_CHANGES" ]; then
            echo "No relevant updates detected. Continuing with full stack execution."
          else
            echo "Detected VoltAir updates: $NEW_CHANGES"
            echo "Applying updates..."
            git config --global user.name "VoltAir Auto-Merge Bot"
            git config --global user.email "voltair-bot@voltairglobalhub.com"
            git pull origin main
            git add .
            git commit -m "Auto-merge VoltAir Supreme updates [skip ci]" || echo "Nothing to commit"
            git push origin main
          fi

      # 3Ô∏è‚É£ Set up Docker for Jekyll
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 4Ô∏è‚É£ Build Jekyll site via Docker
      - name: Build Jekyll site
        run: |
          docker run --rm -v ${{ github.workspace }}:/srv/jekyll -p 4000:4000 jekyll/jekyll:4.3 jekyll build

      # 5Ô∏è‚É£ Generate SLSA3 Provenance
      - name: Generate SLSA3 Provenance
        uses: github/slsa-generic-generator@v1
        with:
          output-file: .github/slsa/provenance.json

      # 6Ô∏è‚É£ Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org/'

      # 7Ô∏è‚É£ Install Node.js dependencies
      - name: Install dependencies
        run: npm install

      # 8Ô∏è‚É£ Run Node.js tests
      - name: Run tests
        run: npm test

      # 9Ô∏è‚É£ Publish Node.js package
      - name: Publish Node.js package
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # üîü Deploy Jekyll site to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v5
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.PUBLISH_DIR }}

      # 1Ô∏è‚É£1Ô∏è‚É£ Completion confirmation
      - name: VoltAir Supreme Execution Complete
        run: echo "‚ö° VoltAir Supreme Continuous Execution completed successfully! All phases executed."
